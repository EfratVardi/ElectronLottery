<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>ממשק ניהול</title>
</head>

<body onload="onLoad()">
    <link href="styleSheets/MainStyleSheet.css" rel="stylesheet" />
    <link href="styleSheets/ManageStyleSheet.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <script src="js/ag-grid-community.min.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/xlsx.full.min.js"></script>
    <script src="js/shared.js"></script>
    <script>
        var manageConfig = ""
        var gridOptions
        var counter = 0;

        function onLoad() {
            fileName = 'manageConfig'
            window.expose.SendExcel("sendReadExcel", fileName);
            window.expose.ReceiveExcel("receiveReadExcel" + fileName, (data) => {
                if (data != 0) {
                    manageConfig = JSON.parse(data)
                    gridOptions = {
                        columnDefs: [
                            { headerName: 'קוד', field: "id", },
                            { headerName: "שם", field: "name", editable: true },
                            { headerName: "תיאור", field: "description", editable: true },
                            { headerName: "מספר זוכה", field: "lotteryNumber" },
                        ],
                        rowData: manageConfig.gifts,
                        onFirstDataRendered: onFirstDataRendered,
                        onCellEditingStopped: onCellEditingStopped
                    };
                    var gridDiv = document.querySelector('#giftsGrid');
                    new agGrid.Grid(gridDiv, gridOptions);
                }
            })
        }

        document.addEventListener("keypress", function (e) {
            if (e.target.tagName !== "INPUT") {
                var input = document.querySelector(".my-input");
                input.focus();
                input.value = e.key;
                e.preventDefault();
            }
            counter += 1;
            if (counter > 9) {
                if (document.getElementById('code').value == '011429519')
                    login("System")
            }
        });

        function onFirstDataRendered(params) {
            gridOptions.api.sizeColumnsToFit({
                defaultMinWidth: 50,
            });
        }

        function New() {
            var id = 0
            if (manageConfig.gifts.length > 0) {
                id = manageConfig.gifts[manageConfig.gifts.length - 1].id + 1
            }
            manageConfig.gifts.push({
                "id": id,
                "name": "",
                "description": "",
                "lotteryNumber": null
            })
            fileName = 'manageConfig'
            window.expose.SendExcel("sendWriteExcel", [fileName, JSON.stringify(manageConfig)]);
            window.expose.ReceiveExcel("receiveWriteExcel" + fileName, (data) => {
                location.reload()
            });
        }

        function onCellEditingStopped(params) {
            fileName = 'manageConfig'
            window.expose.SendExcel("sendWriteExcel", [fileName, JSON.stringify(manageConfig)]);
            window.expose.ReceiveExcel("receiveWriteExcel" + fileName, (data) => {
            });
        }

        function Export(name) {
            var params = {
                fileName: name,
            };
            gridOptions.api.exportDataAsCsv(params);
        }
    </script>
    <div class="background" id="background">
        <div class="text">
            <div id="line1">ברוכה הבאה לממשק ניהול</div>
            <div id="line2">כאן אפשר לצפות, לערוך ולהוריד את הנתונים</div>
            <img style="margin-left: 10px;" onclick="New()" src="resources/file-plus.svg" />
            <img style="margin-left: 10px;" onclick="Export('רשימת הזוכים')" src="resources/file-earmark-excel.svg" />
            <img onclick="expose.appClose()" src="resources/box-arrow-left.svg" />
            <div id="giftsGrid" style="width:80%" class="ag-theme-alpine"></div>
        </div>
        <button onclick="login('User')">הגרלה</button>
        <input type="text" class="my-input" id="code">
    </div>
</body>

</html>