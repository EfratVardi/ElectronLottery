<!DOCTYPE html>
<html>

<head>
    <title>Lottery</title>
</head>

<body onload="onLoad()">
    <link href="styleSheets/MainStyleSheet.css" rel="stylesheet" />
    <link href="styleSheets/UserStyleSheet.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <script src="js/shared.js"></script>
    <link rel="stylesheet" type="text/css" href="StyleSheets/lottery.css">
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-1.12.4.min.js"></script>

    <script>
        var manageConfig = ""
        var gifts
        var systemConfig = ""
        var currentDate = getTodayDate();

        function onLoad() {
            fileName = 'systemConfig'
            window.expose.SendExcel("sendReadExcel", fileName);
            window.expose.ReceiveExcel("receiveReadExcel" + fileName, (data) => {
                if (data != 0) {
                    systemConfig = JSON.parse(data)
                    if (currentDate > systemConfig.date) {
                        login("Expired");
                    }
                    fileName = 'manageConfig'
                    window.expose.SendExcel("sendReadExcel", fileName);
                    window.expose.ReceiveExcel("receiveReadExcel" + fileName, (data) => {
                        manageConfig = JSON.parse(data)
                        gifts = manageConfig.gifts;
                        // Populate the gifts dropdown
                        var giftsDropdown = document.querySelector("#gifts-dropdown");

                        gifts.forEach(function (gift) {
                            var option = document.createElement("option");
                            option.value = gift.id;
                            option.textContent = gift.name;
                            giftsDropdown.appendChild(option);
                        });
                    })
                }
            })
        }

        // Define a function to generate a random integer between min (inclusive) and max (inclusive)
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // Define a function to generate a random lottery number with 5 digits between min and max
        function generateLotteryNumber() {
            var selectedGiftIndex = document.querySelector("#gifts-dropdown").value;
            var selectedGift = gifts.find(x => x.id == selectedGiftIndex)
            var min = parseInt(systemConfig.min);
            var max = parseInt(systemConfig.max);
            var canGenerateAgain = false;
            var lotteryNumber;

            do {
                // Generate a random number between min and max (inclusive)
                lotteryNumber = getRandomInt(min, max).toString();
                var lotteryNumberInputs = document.querySelectorAll(".innerB");
                var count = lotteryNumberInputs.length;
                if (count > lotteryNumber.length) {
                    lotteryNumber = '0'.repeat(count - lotteryNumber.length) + lotteryNumber;
                }
            } while (!canGenerateAgain && gifts.some(gift => gift.lotteryNumber === lotteryNumber));


            // Update the lottery number of the current gift
            selectedGift.lotteryNumber = lotteryNumber;
            gifts.find(x => x.id == selectedGiftIndex).lotteryNumber = lotteryNumber
            lottery()
            // Display the generated lottery number on the page
            // var digits = lotteryNumber.toString().split("");
            // lotteryNumberInputs.forEach(function (input, index) {
            //     input.innerHTML = digits[index];
            // });

            //Update in TXT file
            fileName = "manageConfig"
            manageConfig.gifts = gifts
            window.expose.SendExcel("sendWriteExcel", [fileName, JSON.stringify(manageConfig)]);
            window.expose.ReceiveExcel("receiveWriteExcel" + fileName, (data) => {
            });

            // Change the button text to "Lottery Again"
            var lotteryBtn = document.querySelector("#lottery-btn");
            lotteryBtn.textContent = "הגרלה חוזרת";
        }

        // Define a function to display the selected gift
        function displaySelectedGift() {
            var name = document.querySelector("#line1");
            var description = document.querySelector("#line2");
            var selectedIndex = document.querySelector("#gifts-dropdown").value;
            var selectedGift = gifts.find(x => x.id == selectedIndex)
            document.getElementById("line1").innerHTML = selectedGift.name;
            document.getElementById("line2").innerHTML = selectedGift.description;

            // Display the lottery number if the gift has already been won
            var lotteryNumberInputs = document.querySelectorAll(".innerB");
            if (selectedGift.lotteryNumber !== null) {
                var digits = selectedGift.lotteryNumber.toString().split("");
                lotteryNumberInputs.forEach(function (input, index) {
                    input.innerHTML = digits[index];
                });
            } else {
                lotteryNumberInputs.forEach(function (input) {
                    input.innerHTML = "";
                });
            }

            // Change the button text to "Lottery Again" if the selected gift has already been won
            var lotteryBtn = document.querySelector("#lottery-btn");
            if (selectedGift.lotteryNumber !== null) {
                lotteryBtn.textContent = "הגרלה חוזרת";
            } else {
                lotteryBtn.textContent = "הגרלה";
            }
        }

        function start() {
            document.getElementById("start").style.display = "none";
            document.getElementById("lottery").style.display = "block";
            document.getElementById("container").style.display = "flex";
            displaySelectedGift()
        }

        function lottery() {
            var numbers = new Array;
            for (let i = 1; i <= 20; i++) {
                numbers.push(i);
            }
            generate(numbers)
        }

        function generate(numbers) {
            for (var i = 1; i < 5; i++) {
                createNums($("#B" + i + " .innerB"), i, numbers)
            }
            for (var i = 1; i < 5; i++) {
                moveNums($("#B" + i + " .innerB"), i, numbers)
            }
        };

        function createNums(obj, idNum, numbers) {
            for (var i = 0; i < numbers.length * 2; i++) {
                var chosen = Math.floor(Math.random() * numbers.length);
                obj.append('<div class="number" id="ID_' + idNum + '-' + i + '">' + numbers[chosen] + '</div>')
            }
        }

        function moveNums(obj, idNum) {
            var time = 9000;
            time += Math.round(Math.random() * 1000);
            obj.stop(!0, !0);
            obj.css('margin-top', '-2080px');
            obj.animate({
                "margin-top": "-1040px"
            }, {
                'duration': time,
                'easing': 'swing'
            })
        };
    </script>
    <div class="background" id="background" style="background-image:url('resources/userBackground.gif');">
        <div class="text">
            <div id="line1">ברוכות הבאות להגרלה</div>
            <div id="line2"></div>
            <div id="lottery" style="display: none;">
                <select id="gifts-dropdown" onchange="displaySelectedGift()">
                </select>
                <button id="lottery-btn" onclick="generateLotteryNumber()">Generate Number</button>
            </div>
            <div id="start" style="display: block;">
                <button id="lottery-btn" onclick="start()">התחלה</button>
            </div>
            <br>
            <br>
            <div class="container" id="container">
                <ul class="balls big">
                    <li class="ball" id="B1">
                        <span class="innerA">
                            <span class="innerB">
                            </span>
                        </span>
                    </li>
                    <li class="ball" id="B2">
                        <span class="innerA">
                            <span class="innerB">
                            </span>
                        </span>
                    </li>
                    <li class="ball" id="B3">
                        <span class="innerA">
                            <span class="innerB">
                            </span>
                        </span>
                    </li>
                    <li class="ball" id="B4">
                        <span class="innerA">
                            <span class="innerB">
                            </span>
                        </span>
                    </li>
                </ul>
            </div>
            <input type="button" value="click" onclick="lottery()" name="generate_numbers" class="btn btn-block">
        </div>
        <button onclick="login('Manage')">הגדרות</button>
    </div>
</body>

</html>